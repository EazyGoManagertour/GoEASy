@using GoEASy.Models
@using System.Web
@model GoEASy.Models.Tour
<!DOCTYPE html>
<html lang="zxx">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/assets/images/logos/favicon.png" type="image/x-icon">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">

    <!-- Flaticon -->
    <link rel="stylesheet" href="/assets/css/jquery-ui.min.css">

    <!-- Additional CSS for Tour List (not in shared) -->
    <link rel="stylesheet" href="/assets/css/flaticon.min.css">
    <link rel="stylesheet" href="/assets/css/fontawesome-5.14.0.min.css">
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/magnific-popup.min.css">
    <link rel="stylesheet" href="/assets/css/nice-select.min.css">
    <link rel="stylesheet" href="/assets/css/aos.css">
    <link rel="stylesheet" href="/assets/css/slick.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
    <div class="page-wrapper">

        <!-- Preloader -->
        <div class="preloader"><div class="custom-loader"></div></div>

        <!-- main header -->
        <header class="main-header header-one white-menu menu-absolute" id="tourlist-header">
            @await Html.PartialAsync("~/Views/client/share/header.cshtml")
        </header>

        <!--Form Back Drop-->
        <div class="form-back-drop"></div>
        <!-- Hidden Sidebar -->
        <section class="hidden-bar">
            <div class="inner-box text-center">
                <div class="cross-icon"><span class="fa fa-times"></span></div>
                <div class="title">
                    <h4>Get Appointment</h4>
                </div>
                <!--Appointment Form-->
                <div class="appointment-form">
                    <form method="post" action="https://webtendtheme.net/html/2024/ravelo/contact.html">
                        <div class="form-group">
                            <input type="text" name="text" value="" placeholder="Name" required>
                        </div>
                        <div class="form-group">
                            <input type="email" name="email" value="" placeholder="Email Address" required>
                        </div>
                        <div class="form-group">
                            <textarea placeholder="Message" rows="5"></textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="theme-btn style-two">
                                <span data-hover="Submit now">Submit now</span>
                                <i class="fal fa-arrow-right"></i>
                            </button>
                        </div>
                    </form>
                </div>
                <!--Social Icons-->
                <div class="social-style-one">
                    <a href="contact.html"><i class="fab fa-twitter"></i></a>
                    <a href="contact.html"><i class="fab fa-facebook-f"></i></a>
                    <a href="contact.html"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-pinterest-p"></i></a>
                </div>
            </div>
        </section>
        <!--End Hidden Sidebar -->
        <!-- Page Banner Start -->
        <section class="page-banner-two rel z-1" style="padding-top: 180px;">
            <div class="container-fluid">
                <hr class="mt-0">
                <div class="container">
                    <div class="banner-inner pt-15 pb-25">
                        <h2 class="page-title mb-10" data-aos="fade-left" data-aos-duration="1500" data-aos-offset="50">@Model.TourName</h2>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb justify-content-center mb-20" data-aos="fade-right" data-aos-delay="200" data-aos-duration="1500" data-aos-offset="50">
                                <li class="breadcrumb-item"><a href="/">Home</a></li>
                                <li class="breadcrumb-item active">Tour Details</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </section>
        <!-- Page Banner End -->
        <!-- Tour Gallery start -->
        @{
            var images = Model.TourImages.Take(5).ToList();
        }
        <div class="tour-gallery">
            <div class="container-fluid">
                <div class="row gap-10 justify-content-center rel">
                    <div class="col-lg-4 col-md-6 d-flex flex-column gap-3">
                        @if (images.Count > 0)
                        {
                            <div class="gallery-item">
                                <img src="@Url.Content(images[0].ImageURL)" style="width:100%;height:316.05px;object-fit:cover;border-radius:16px;" alt="Tour Image 1" />
                            </div>
                        }
                        @if (images.Count > 1)
                        {
                            <div class="gallery-item">
                                <img src="@Url.Content(images[1].ImageURL)" style="width:100%;height:316.05px;object-fit:cover;border-radius:16px;" alt="Tour Image 2" />
                            </div>
                        }
                    </div>
                    <div class="col-lg-4 col-md-6">
                        @if (images.Count > 2)
                        {
                            <div class="gallery-item">
                                <img src="@Url.Content(images[2].ImageURL)" style="width:100%;height:640.01px;object-fit:cover;border-radius:16px;" alt="Tour Image 3" />
                            </div>
                        }
                    </div>
                    <div class="col-lg-4 col-md-6 d-flex flex-column gap-3">
                        @if (images.Count > 3)
                        {
                            <div class="gallery-item">
                                <img src="@Url.Content(images[3].ImageURL)" style="width:100%;height:316.05px;object-fit:cover;border-radius:16px;" alt="Tour Image 4" />
                            </div>
                        }
                        @if (images.Count > 4)
                        {
                            <div class="gallery-item">
                                <img src="@Url.Content(images[4].ImageURL)" style="width:100%;height:316.05px;object-fit:cover;border-radius:16px;" alt="Tour Image 5" />
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
        <!-- Tour Gallery End -->
        <!-- Tour Header Area start -->
        <section class="tour-header-area pt-70 rel z-1">
            <div class="container">
                <div class="row justify-content-between">
                    <div class="col-xl-6 col-lg-7">
                        <div class="tour-header-content mb-15" data-aos="fade-left" data-aos-duration="1500" data-aos-offset="50">
                            <span class="location d-inline-block mb-10"><i class="fal fa-map-marker-alt"></i> @Model.Destination?.DestinationName</span>
                            <div class="section-title pb-5">
                                <h2>@Model.TourName</h2>
                            </div>
                        </div>
                    </div>

                </div>
                <hr class="mt-50 mb-70">
            </div>
        </section>
        <!-- Tour Header Area end -->
        <!-- Tour Details Area start -->
        <section class="tour-details-page pb-100">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="tour-details-content">
                            <h3>Khám Phá Tour</h3>
                            <p>@Model.Description</p>
                            <div class="row pb-55">
                                <div class="col-md-6">
                                    <div class="tour-include-exclude mt-30">
                                        <h5>Bao Gồm Và Không Bao Gồm</h5>
                                        <ul class="list-style-one check mt-25">
                                            @foreach (var item in (List<string>)ViewBag.IncludedList)
                                            {
                                                <li><i class="far fa-check"></i> @item</li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="tour-include-exclude mt-30">
                                        <h5>Không Bao Gồm</h5>
                                        <ul class="list-style-one mt-25">
                                            @foreach (var item in (List<string>)ViewBag.ExcludedList)
                                            {
                                                <li><i class="far fa-times"></i> @item</li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button id="showCustomBooking" class="theme-btn style-two mt-3 mb-3" style="border-radius: 8px; font-weight: 500; letter-spacing: 0.5px;">Custom Booking</button>
                        <!-- Khung Custom Booking ẩn -->
                        <div class="widget widget-booking" id="customBookingBox" style="display:none; width:100%; margin-bottom:24px; background:#f9f9f9; border:1px solid #e5e5e5; border-radius:16px; box-shadow:0 4px 24px rgba(0,0,0,0.07); padding:32px 28px 24px 28px;">
                            <h5 class="widget-title">Custom Booking</h5>
                            <form id="customBookingForm" method="post" action="/booking/create">
                                <input type="hidden" name="TourID" value="@Model.TourID" />
                                <input type="hidden" name="adultGuests" id="customAdultGuests" value="0" />
                                <input type="hidden" name="childGuests" id="customChildGuests" value="0" />
                                <input type="hidden" name="totalPrice" id="customTotalPrice" value="0" />
                                <input type="hidden" name="isCustom" value="true" />

                                <div class="date mb-3">
                                    <label class="form-label" style="font-weight:600;">Ngày khởi hành</label>
                                    <input type="date" class="form-control" name="customStartDate" id="customStartDate" style="border-radius:8px; border:1px solid #e5e5e5; background:#fff; width:100%;" required />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight:600;">Số vé người lớn</label>
                                    <input type="number" class="form-control" id="customAdult" min="0" value="0" style="border-radius:8px; border:1px solid #e5e5e5; background:#fff; width:100%;" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight:600;">Số vé trẻ em</label>
                                    <input type="number" class="form-control" id="customChild" min="0" value="0" style="border-radius:8px; border:1px solid #e5e5e5; background:#fff; width:100%;" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight:600;">Mã giảm giá (tùy chọn)</label>
                                    <input type="text" class="form-control" name="customDiscount" placeholder="Nhập mã giảm giá nếu có" style="border-radius:8px; border:1px solid #e5e5e5; background:#fff; width:100%;" />
                                </div>
                                <button type="button" id="customCalcBtn" class="theme-btn style-two w-100 mb-2" style="border-radius:8px;">Tính tổng</button>
                                <hr>
                                <h6 style="font-weight:600;">Total: <span class="price" id="customTotal">0</span> đ</h6>
                                <button type="submit" class="theme-btn style-two w-100 mt-2" style="border-radius:8px; background: #a50064; border-color: #a50064; color: #fff;">Đặt tour với MoMo <img src='/assets/images/momo-logo.png' alt='MoMo' style='height:20px;margin-left:8px;vertical-align:middle;' /></button>
                            </form>
                        </div>

                        <h3>Hoạt Động</h3>
                        <div class="tour-activities mt-30 mb-45">
                            @if (ViewBag.ActivitiesList != null && ((List<string>)ViewBag.ActivitiesList).Count > 0)
                            {
                                foreach (var activity in (List<string>)ViewBag.ActivitiesList)
                                {
                                    <div class="tour-activity-item">
                                        <i class="flaticon-hiking"></i>
                                        <b>@activity</b>
                                    </div>
                                }
                            }
                            else
                            {
                                <!-- Default activities if no data -->
                                <div class="tour-activity-item">
                                    <i class="flaticon-hiking"></i>
                                    <b>Hiking</b>
                                </div>
                                <div class="tour-activity-item">
                                    <i class="flaticon-fishing"></i>
                                    <b>Fishing</b>
                                </div>
                                <div class="tour-activity-item">
                                    <i class="flaticon-man"></i>
                                    <b>Kayak shooting</b>
                                </div>
                                <div class="tour-activity-item">
                                    <i class="flaticon-kayak-1"></i>
                                    <b>Kayak</b>
                                </div>
                                <div class="tour-activity-item">
                                    <i class="flaticon-bonfire"></i>
                                    <b>Campfire</b>
                                </div>
                                <div class="tour-activity-item">
                                    <i class="flaticon-flashlight"></i>
                                    <b>Night Exploring</b>
                                </div>
                                <div class="tour-activity-item">
                                    <i class="flaticon-cycling"></i>
                                    <b>Biking</b>
                                </div>
                                <div class="tour-activity-item">
                                    <i class="flaticon-meditation"></i>
                                    <b>Yoga</b>
                                </div>
                            }
                        </div>

                        <h3>Lịch trình tour</h3>
                        <div class="accordion" id="itineraryAccordion">
                            @if (ViewBag.Itineraries != null)
                            {
                                int idx = 0;
                                foreach (var item in (IEnumerable<GoEASy.Models.TourItinerary>)ViewBag.Itineraries)
                                {
                                    var collapseId = $"collapseDay{item.DayNumber}";
                                    <div class="accordion-item">
                                        <h5 class="accordion-header">
                                            <button class="accordion-button @(idx == 0 ? "" : "collapsed")" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="@(idx == 0 ? "true" : "false")">
                                                @item.Title
                                            </button>
                                        </h5>
                                        <div id="@collapseId" class="accordion-collapse collapse @(idx == 0 ? "show" : "")" data-bs-parent="#itineraryAccordion">
                                            <div class="accordion-body">
                                                <p>@item.Description</p>
                                                @if (!string.IsNullOrEmpty(item.Meals))
                                                {
                                                    <p><b>Bữa ăn:</b> @item.Meals</p>
                                                }
                                                @if (!string.IsNullOrEmpty(item.Accommodation))
                                                {
                                                    <p><b>Lưu trú:</b> @item.Accommodation</p>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    idx++;
                                }
                            }
                        </div>

                        <h3>FAQs</h3>
                        <div class="accordion" id="faqAccordion">
                            @if (ViewBag.FAQs != null)
                            {
                                int idx = 0;
                                foreach (var faq in (IEnumerable<GoEASy.Models.TourFAQ>)ViewBag.FAQs)
                                {
                                    var collapseId = $"collapseFaq{faq.FAQID}";
                                    <div class="accordion-item">
                                        <h5 class="accordion-header">
                                            <button class="accordion-button @(idx == 0 ? "" : "collapsed")" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="@(idx == 0 ? "true" : "false")">
                                                @faq.Question
                                            </button>
                                        </h5>
                                        <div id="@collapseId" class="accordion-collapse collapse @(idx == 0 ? "show" : "")" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                <p>@faq.Answer</p>
                                            </div>
                                        </div>
                                    </div>
                                    idx++;
                                }
                            }
                        </div>

                        <h3>Bản đồ</h3>
                        <div class="tour-map mt-30 mb-50">
                            <iframe width="100%"
                                    height="350"
                                    style="border:0"
                                    loading="lazy"
                                    allowfullscreen
                                    referrerpolicy="no-referrer-when-downgrade"
                                    src="https://www.google.com/maps?q=@Uri.EscapeDataString(Model.Destination?.Location ?? Model.Destination?.DestinationName ?? "Việt Nam")&output=embed">
                            </iframe>
                        </div>



                        <h3>Bình Luận Khách Hàng</h3>
                        <div class="comments mt-30 mb-60">
                            @if (ViewBag.ClientFeedbacks != null && ((List<GoEASy.Models.Review>)ViewBag.ClientFeedbacks).Count > 0)
                            {
                                foreach (var feedback in (List<GoEASy.Models.Review>)ViewBag.ClientFeedbacks)
                                {
                                    <div class="comment-body" data-aos="fade-up" data-aos-duration="1500" data-aos-offset="50">
                                        <div class="author-thumb">
                                            <img src="@Url.Content("~/assets/images/blog/comment-author1.jpg")" alt="Author">
                                        </div>
                                        <div class="content">
                                            <h6>@feedback.User?.FullName</h6>
                                            <div class="ratting">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    if (i <= feedback.Rating)
                                                    {
                                                        <i class="fas fa-star"></i>
                                                    }
                                                    else
                                                    {
                                                        <i class="far fa-star"></i>
                                                    }
                                                }
                                            </div>
                                            <span class="time">@feedback.CreatedDate?.ToString("dd/MM/yyyy HH:mm")</span>
                                            <p>@feedback.Comment</p>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div>Chưa có bình luận nào.</div>
                            }
                        </div>

                        <h3>Thêm bình luận</h3>
                        @if (ViewBag.CanComment == true)
                        {
                            <form id="comment-form" class="comment-form bgc-lighter z-1 rel mt-30" name="review-form" action="/review/post" method="post" data-aos="fade-up" data-aos-duration="1500" data-aos-offset="50">
                                <input type="hidden" name="TourID" value="@Model.TourID" />
                                <div class="form-group">
                                    <label>Đánh giá (1-5 sao)</label>
                                    <div id="star-rating" style="font-size: 2rem; color: #ffc107; cursor: pointer;">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="far fa-star" data-value="@i"></i>
                                        }
                                    </div>
                                    <input type="hidden" name="rating" id="rating" required />
                                </div>
                                <div class="form-group">
                                    <label for="comment">Bình luận</label>
                                    <textarea name="comment" id="comment" class="form-control" rows="4" required></textarea>
                                </div>
                                <div class="form-group mb-0">
                                    <button type="submit" class="theme-btn bgc-secondary style-two">
                                        <span data-hover="Gửi bình luận">Gửi bình luận</span>
                                        <i class="fal fa-arrow-right"></i>
                                    </button>
                                </div>
                            </form>
                            <script>
    var policyData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.ChildPolicyData ?? new { MinAdultsPerChild = 1, MaxChildrenPerAdult = 3 }));
    // Gắn event submit cho bookingForm ngay lập tức
    var bookingForm = document.getElementById('booking-form');
    if (bookingForm) {
        bookingForm.addEventListener('submit', function(e) {
            var adult = parseInt(document.getElementById('adultQty').value) || 0;
            var child = parseInt(document.getElementById('childQty').value) || 0;
            console.log('submit booking', { adult, child, policyData });
            if (adult <= 0) {
                showProfessionalNotification('Phải có ít nhất 1 người lớn trong tour.');
                e.preventDefault();
                return false;
            }
            if (child > adult * policyData.MaxChildrenPerAdult) {
                showProfessionalNotification('Tối đa ' + policyData.MaxChildrenPerAdult + ' trẻ em cho mỗi người lớn. Vui lòng điều chỉnh lại số lượng.');
                e.preventDefault();
                return false;
            }
        });
    }
</script>
                        }
                        else
                        {
                            <div style="background: #f1f1f1; border-radius: 12px; padding: 32px 24px; margin-top: 24px; text-align: center; color: #888; font-size: 1.1rem; font-style: italic;">
                                Bạn cần đặt và thanh toán tour này để có thể bình luận.
                            </div>
                        }

                    </div>
                    <div class="col-lg-4 col-md-8 col-sm-10 rmt-75">
                        <div class="blog-sidebar tour-sidebar">

                            <div class="widget widget-booking" data-aos="fade-up" data-aos-duration="1500" data-aos-offset="50">
                                <h5 class="widget-title">Tour Booking</h5>
                                <form id="booking-form" method="post" action="/booking/create">
                                    <input type="hidden" name="TourID" value="@Model.TourID" />
                                    <input type="hidden" name="adultGuests" id="adultGuests" value="0" />
                                    <input type="hidden" name="childGuests" id="childGuests" value="0" />
                                    <input type="hidden" name="totalPrice" id="totalPriceInput" value="0" />
                                    <div class="date mb-25">
                                        <b>From Date</b>
                                        <input type="text" value="@(((DateTime)Model.StartDate).ToString("yyyy-MM-dd"))" readonly style="background:#f9f9f9;cursor:not-allowed;">
                                    </div>
                                    <hr>
                                    <div class="date mb-25">
                                        <b>End Date</b>
                                        <input type="text" value="@(((DateTime)Model.EndDate).ToString("yyyy-MM-dd"))" readonly style="background:#f9f9f9;cursor:not-allowed;">
                                    </div>
                                    <hr class="mb-25">
                                    <h6>Mã giảm giá:</h6>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" name="discountCode" id="discountCode" placeholder="Nhập mã giảm giá" autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" id="checkDiscountBtn">Áp dụng</button>
                                    </div>
                                    <div id="discountMessage" style="color: #28a745; font-size: 0.95em; min-height: 22px;"></div>
                                    <input type="hidden" name="discountId" id="discountId" value="" />
                                    <input type="hidden" name="discountAmount" id="discountAmount" value="0" />
                                    
                                    <h6>Tickets:</h6>
                                    <ul class="tickets clearfix">
                                        <li>
                                            Adult (14+ years) <span class="price">@(((decimal)Model.AdultPrice).ToString("N0")) đ</span>
                                            <select name="adultQty" id="adultQty">
                                                @for (int i = 0; i <= 10; i++)
                                                {
                                                    <option value="@i" @(i == 0 ? "selected" : "")>@i.ToString("D2")</option>
                                                }
                                            </select>
                                        </li>
                                        <li>
                                            Children (<14 years) <span class="price">@(((decimal)Model.ChildPrice).ToString("N0")) đ</span>
                                            <select name="childQty" id="childQty">
                                                    @for (int i = 0; i <= 10; i++)
                                                    {
                                                            <option value="@i" @(i == 0 ? "selected" : "")>@i.ToString("D2")</option>
                                                    }
                                            </select>
                                        </li>
                                    </ul>
                                    <hr class="mb-25">
                                    <h6>Total: <span class="price" id="totalPrice">0</span> đ</h6>
                                    <button type="button" id="calculateBtn" class="theme-btn style-two w-100 mt-15 mb-5">
                                        <span data-hover="Calculate Total">Calculate Total</span>
                                        <i class="fal fa-calculator"></i>
                                    </button>
                                    
                                    <button type="submit" class="theme-btn style-two w-100 mt-15 mb-5" style="background: #a50064; border-color: #a50064; color: #fff;">
                                        <span data-hover="Thanh toán MoMo">Thanh toán MoMo</span>
                                        <img src='/assets/images/momo-logo.png' alt='MoMo' style='height:20px;margin-left:8px;vertical-align:middle;' />
                                    </button>
                                    <div class="text-center">
                                        <a href="contact.html">Cần trợ giúp?</a>
                                    </div>
                                </form>
                            </div>
                            <script>
                                var policyData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.ChildPolicyData ?? new { MinAdultsPerChild = 1, MaxChildrenPerAdult = 3 }));
                                document.addEventListener('DOMContentLoaded', function() {
                                    var calculateBtn = document.getElementById('calculateBtn');
                                    var adultQty = document.getElementById('adultQty');
                                    var childQty = document.getElementById('childQty');
                                    var totalPriceSpan = document.getElementById('totalPrice');
                                    var totalPriceInput = document.getElementById('totalPriceInput');
                                    var adultGuestsInput = document.getElementById('adultGuests');
                                    var childGuestsInput = document.getElementById('childGuests');
                                    var bookingForm = document.getElementById('booking-form');
                                    // Thêm event cho nút Calculate Total
                                    if (calculateBtn) {
                                        calculateBtn.addEventListener('click', function() {
                                            updateBookingInputs();
                                        });
                                    }
                                    
                                    // Thêm event listeners cho select boxes để kiểm tra validation
                                    if (adultQty) {
                                        adultQty.addEventListener('change', function() {
                                            var adult = parseInt(adultQty.value) || 0;
                                            var child = parseInt(childQty.value) || 0;
                                            validateAndAutoAdjust(adult, child);
                                        });
                                    }
                                    
                                    if (childQty) {
                                        childQty.addEventListener('change', function() {
                                            var adult = parseInt(adultQty.value) || 0;
                                            var child = parseInt(childQty.value) || 0;
                                            validateAndAutoAdjust(adult, child);
                                        });
                                    }
                                    
                                    // Thêm event cho nút Áp dụng mã giảm giá
                                    var checkDiscountBtn = document.getElementById('checkDiscountBtn');
                                    var discountCode = document.getElementById('discountCode');
                                    var discountMessage = document.getElementById('discountMessage');
                                    var discountId = document.getElementById('discountId');
                                    var discountAmount = document.getElementById('discountAmount');

                                    if (checkDiscountBtn) {
                                        checkDiscountBtn.addEventListener('click', function() {
                                            var code = discountCode.value.trim();
                                            console.log('Checking discount code:', code);
                                            if (!code) {
                                                discountMessage.innerHTML = '<span style="color: #dc3545;">Vui lòng nhập mã giảm giá!</span>';
                                                return;
                                            }
                                            
                                            var totalPrice = parseFloat(totalPriceInput.value) || 0;
                                            console.log('Total price:', totalPrice);
                                            
                                            // Gọi API kiểm tra mã giảm giá
                                            console.log('Calling API...');
                                            fetch('/coupons/check', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                    'X-Requested-With': 'XMLHttpRequest'
                                                },
                                                body: JSON.stringify({
                                                    code: code,
                                                    tourId: @Model.TourID,
                                                    totalPrice: totalPrice
                                                })
                                            })
                                            .then(response => {
                                                console.log('Response status:', response.status);
                                                return response.json();
                                            })
                                            .then(data => {
                                                console.log('Response data:', data);
                                                if (data.success) {
                                                    discountMessage.innerHTML = '<span style="color: #28a745;">✓ Mã giảm giá hợp lệ! Giảm ' + data.discountAmount.toLocaleString() + ' đ</span>';
                                                    discountId.value = data.discountId;
                                                    discountAmount.value = data.discountAmount;
                                                    
                                                    // Cập nhật tổng tiền sau khi áp dụng mã giảm giá
                                                    var currentTotal = parseFloat(totalPriceInput.value) || 0;
                                                    var newTotal = currentTotal - data.discountAmount;
                                                    if (newTotal < 0) newTotal = 0;
                                                    
                                                    totalPriceSpan.innerText = newTotal.toLocaleString();
                                                    totalPriceInput.value = newTotal;
                                                } else {
                                                    discountMessage.innerHTML = '<span style="color: #dc3545;">✗ ' + data.message + '</span>';
                                                    discountId.value = '';
                                                    discountAmount.value = 0;
                                                    

                                                }
                                            })
                                            .catch(error => {
                                                console.error('Fetch error:', error);
                                                discountMessage.innerHTML = '<span style="color: #dc3545;">✗ Có lỗi xảy ra, vui lòng thử lại!</span>';
                                                discountId.value = '';
                                                discountAmount.value = 0;
                                            });
                                        });
                                    }
    if (bookingForm) {
        bookingForm.addEventListener('submit', function(e) {
            var adult = parseInt(adultQty.value) || 0;
            var child = parseInt(childQty.value) || 0;
            
            // Kiểm tra validation trước khi submit
            if (!validateAndAutoAdjust(adult, child)) {
                e.preventDefault();
                return false;
            }
            
            if (adult <= 0) {
                showProfessionalNotification('Phải có ít nhất 1 người lớn trong tour.');
                e.preventDefault();
                return false;
            }
            if (child > adult * policyData.MaxChildrenPerAdult) {
                showProfessionalNotification('Tối đa ' + policyData.MaxChildrenPerAdult + ' trẻ em cho mỗi người lớn. Vui lòng điều chỉnh lại số lượng.');
                e.preventDefault();
                return false;
            }
        });
    }

                                    function updateBookingInputs() {
                                        var adult = parseInt(adultQty.value) || 0;
                                        var child = parseInt(childQty.value) || 0;
                                        
                                        // Kiểm tra validation trước khi tính tổng
                                        if (!validateAndAutoAdjust(adult, child)) {
                                            // Reset về 0 nếu vi phạm quy tắc
                                            totalPriceSpan.innerText = '0';
                                            totalPriceInput.value = 0;
                                            adultGuestsInput.value = 0;
                                            childGuestsInput.value = 0;
                                            
                                            // Reset mã giảm giá
                                            discountId.value = '';
                                            discountAmount.value = 0;
                                            discountMessage.innerHTML = '';
                                            return false;
                                        }
                                        
                                        var adultPrice = @(((decimal)Model.AdultPrice).ToString(System.Globalization.CultureInfo.InvariantCulture));
                                        var childPrice = @(((decimal)Model.ChildPrice).ToString(System.Globalization.CultureInfo.InvariantCulture));
                                        var total = (adult * adultPrice) + (child * childPrice);
                                        totalPriceSpan.innerText = total.toLocaleString();
                                        totalPriceInput.value = total;
                                        adultGuestsInput.value = adult;
                                        childGuestsInput.value = child;
                                        
                                        // Reset mã giảm giá
                                        discountId.value = '';
                                        discountAmount.value = 0;
                                        discountMessage.innerHTML = '';
                                        
                                        return true;
                                    }
                                    
                                    // Function hiển thị thông báo chuyên nghiệp
                                    function showProfessionalNotification(message) {
                                        // Tạo notification element
                                        var notification = document.createElement('div');
                                        notification.style.cssText = `
                                            position: fixed;
                                            top: 20px;
                                            right: 20px;
                                            background: #dc3545;
                                            color: white;
                                            padding: 15px 20px;
                                            border-radius: 8px;
                                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                            z-index: 9999;
                                            font-size: 14px;
                                            font-weight: 500;
                                            max-width: 300px;
                                            word-wrap: break-word;
                                        `;
                                        notification.textContent = message;
                                        
                                        // Thêm vào body
                                        document.body.appendChild(notification);
                                        
                                        // Tự động xóa sau 4 giây
                                        setTimeout(function() {
                                            if (notification.parentNode) {
                                                notification.parentNode.removeChild(notification);
                                            }
                                        }, 4000);
                                    }
                                    
                                    // Function kiểm tra validation khi thay đổi số lượng
                                    function validateAndAutoAdjust(adult, child) {
                                        // 1. Không cho phép đặt chỉ vé trẻ em (child > 0 && adult == 0)
                                        if (child > 0 && adult == 0) {
                                            showProfessionalNotification('Theo chính sách tour, phải có ít nhất 1 người lớn đi kèm trẻ em. Vui lòng chọn ít nhất 1 vé người lớn.');
                                            return false;
                                        }
                                        
                                        // 2. Không cho phép đặt vé nếu tổng số người = 0
                                        if (adult == 0 && child == 0) {
                                            showProfessionalNotification('Vui lòng chọn ít nhất 1 vé để tiếp tục đặt tour.');
                                            return false;
                                        }
                                        
                                        return true;
                                    }
                                });
                            </script>

                            <div class="widget widget-contact" data-aos="fade-up" data-aos-duration="1500" data-aos-offset="50">
                                <h5 class="widget-title">Cần Trợ Giúp?</h5>
                                <ul class="list-style-one">
                                    <li><i class="far fa-envelope"></i> <a href="emilto:helpxample@gmail.com">helpxample@gmail.com</a></li>
                                    <li><i class="far fa-phone-volume"></i> <a href="callto:+000(123)45688">+000 (123) 456 88</a></li>
                                </ul>
                            </div>

                            <div class="widget widget-cta" data-aos="fade-up" data-aos-duration="1500" data-aos-offset="50">
                                <div class="content text-white">
                                    <span class="h6">Khám Phá Thế Giới</span>
                                    <h3>Điểm Du Lịch Tốt Nhất</h3>
                                    <a href="tour-grid.html" class="theme-btn style-two bgc-secondary">
                                        <span data-hover="Khám Phá Ngay">Khám Phá Ngay</span>
                                        <i class="fal fa-arrow-right"></i>
                                    </a>
                                </div>
                                <div class="image">
                                    <img src="@Url.Content("~/assets/images/widgets/cta-widget.png")" alt="CTA">
                                </div>
                                <div class="cta-shape"><img src="@Url.Content("~/assets/images/widgets/cta-shape3.png")" alt="Shape"></div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Tour Details Area end -->
        <!-- Newsletter Area start -->
        <section class="newsletter-three bgc-primary py-100 rel z-1" style="background-image: url(@Url.Content("~/assets/images/newsletter/newsletter-bg-lines.png"));">
            <div class="container container-1500">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="newsletter-content-part text-white rmb-55" data-aos="zoom-in-right" data-aos-duration="1500" data-aos-offset="50">
                            <div class="section-title counter-text-wrap mb-45">
                                <h2>Đăng Ký Newsletter Để Nhận Ưu Đãi & Mẹo</h2>
                                <p>One site <span class="count-text plus" data-speed="3000" data-stop="34500">0</span> most popular experience you’ll remember</p>
                            </div>
                            <form class="newsletter-form mb-15" action="#">
                                <input id="news-email" type="email" placeholder="Địa chỉ Email" required>
                                <button type="submit" class="theme-btn bgc-secondary style-two">
                                    <span data-hover="Đăng Ký">Đăng Ký</span>
                                    <i class="fal fa-arrow-right"></i>
                                </button>
                            </form>
                            <p>Không yêu cầu thẻ tín dụng. Không cam kết</p>
                        </div>
                        <div class="newsletter-bg-image" data-aos="zoom-in-up" data-aos-delay="100" data-aos-duration="1500" data-aos-offset="50">
                            <img src="@Url.Content("~/assets/images/newsletter/newsletter-bg-image.png")" alt="Newsletter">
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="newsletter-image-part bgs-cover" style="background-image: url(@Url.Content("~/assets/images/newsletter/newsletter-two-right.jpg"));" data-aos="fade-left" data-aos-duration="1500" data-aos-offset="50"></div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Newsletter Area end -->
        @Html.Partial("~/Views/client/share/footer-area.cshtml")
    </div>
    <script src="/assets/js/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap -->
    <script src="/assets/js/bootstrap.min.js"></script>
    <!-- Appear Js -->
    <script src="/assets/js/appear.min.js"></script>
    <!-- Slick -->
    <script src="/assets/js/slick.min.js"></script>
    <!-- Magnific Popup -->
    <script src="/assets/js/jquery.magnific-popup.min.js"></script>
    <!-- Nice Select -->
    <script src="/assets/js/jquery.nice-select.min.js"></script>
    <!-- Image Loader -->
    <script src="/assets/js/imagesloaded.pkgd.min.js"></script>
    <!-- Skillbar -->
    <script src="/assets/js/skill.bars.jquery.min.js"></script>
    <!-- Isotope -->
    <script src="/assets/js/isotope.pkgd.min.js"></script>
    <!--  AOS Animation -->
    <script src="/assets/js/aos.js"></script>
    <!-- Custom script -->
    <script src="/assets/js/script.js"></script>
    <style>
        /* Ghi đè background footer-two.png thành tuyệt đối */
        .main-footer.footer-two {
            background-image: url('/assets/images/backgrounds/footer-two.png') !important;
        }
    </style>
    <script>
        // Ghi đè logo header/footer thành tuyệt đối sau khi partial render
        document.addEventListener('DOMContentLoaded', function() {
            // Header logo
            var logos = document.querySelectorAll('img[src*="assets/images/logos/logo.png"]');
            logos.forEach(function(logo) {
                logo.src = '/assets/images/logos/logo.png';
            });
            // Footer logo
            var footerLogos = document.querySelectorAll('.footer-logo img');
            footerLogos.forEach(function(logo) {
                logo.src = '/assets/images/logos/logo.png';
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var btn = document.getElementById('showCustomBooking');
            var box = document.getElementById('customBookingBox');
            if (btn && box) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'block' : 'none';
                });
            }

            // Custom Booking JavaScript
            var customCalcBtn = document.getElementById('customCalcBtn');
            var customAdult = document.getElementById('customAdult');
            var customChild = document.getElementById('customChild');
            var customTotal = document.getElementById('customTotal');
            var customAdultGuests = document.getElementById('customAdultGuests');
            var customChildGuests = document.getElementById('customChildGuests');
            var customTotalPrice = document.getElementById('customTotalPrice');
            var customBookingForm = document.getElementById('customBookingForm');

            function updateCustomBookingInputs() {
                var adult = parseInt(customAdult.value) || 0;
                var child = parseInt(customChild.value) || 0;
                var adultPrice = @(((decimal)Model.AdultPrice).ToString(System.Globalization.CultureInfo.InvariantCulture));
                var childPrice = @(((decimal)Model.ChildPrice).ToString(System.Globalization.CultureInfo.InvariantCulture));
                var total = (adult * adultPrice) + (child * childPrice);

                customTotal.innerText = total.toLocaleString();
                customTotalPrice.value = total;
                customAdultGuests.value = adult;
                customChildGuests.value = child;

                // Cập nhật ngày khởi hành
                var startDate = document.getElementById('customStartDate').value;
                document.getElementById('customStartDateHidden').value = startDate;
            }

            if (customCalcBtn) {
                customCalcBtn.addEventListener('click', function() {
                    updateCustomBookingInputs();
                });
            }

            // Tự động cập nhật khi thay đổi số lượng
            if (customAdult) {
                customAdult.addEventListener('change', updateCustomBookingInputs);
            }
            if (customChild) {
                customChild.addEventListener('change', updateCustomBookingInputs);
            }

            // Tự động cập nhật khi thay đổi ngày khởi hành
            var customStartDateInput = document.getElementById('customStartDate');
            if (customStartDateInput) {
                customStartDateInput.addEventListener('change', updateCustomBookingInputs);
            }

            // Validate form trước khi submit
            if (customBookingForm) {
                customBookingForm.addEventListener('submit', function(e) {
                    updateCustomBookingInputs();

                    var adult = parseInt(customAdult.value) || 0;
                    var child = parseInt(customChild.value) || 0;
                    var startDate = document.getElementById('customStartDate').value;

                    if (adult === 0 && child === 0) {
                        e.preventDefault();
                        alert('Vui lòng chọn ít nhất 1 vé người lớn hoặc trẻ em!');
                        return false;
                    }

                    if (!startDate) {
                        e.preventDefault();
                        alert('Vui lòng chọn ngày khởi hành!');
                        return false;
                    }

                    // Kiểm tra ngày khởi hành không được trong quá khứ
                    var selectedDate = new Date(startDate);
                    var today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (selectedDate < today) {
                        e.preventDefault();
                        alert('Ngày khởi hành không được trong quá khứ!');
                        return false;
                    }

                    // Hiển thị thông báo đang xử lý
                    var submitBtn = customBookingForm.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = '<span>Đang xử lý...</span>';
                    submitBtn.disabled = true;
                });
            }
        });
    </script>
    
    <script>
        // Kiểm tra và hiển thị thông báo lỗi sau khi reload trang
        window.addEventListener('load', function() {
            // XÓA: var policyError = sessionStorage.getItem('policyError');
            // XÓA: if (policyError) { ... }
        });
    </script>
</body>
</html> 